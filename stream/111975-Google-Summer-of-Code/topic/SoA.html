<html>
<head><meta charset="utf-8"><title>SoA · Google Summer of Code · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/index.html">Google Summer of Code</a></h2>
<h3>Topic: <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html">SoA</a></h3>

<hr>

<base href="https://brlcad.zulipchat.com">

<head><link href="https://brl-cad.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="129095934"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129095934" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129095934">(Jul 04 2018 at 17:18)</a>:</h4>
<p>i've done a first attempt of moving <code>bu_mappedfile</code> to SoA. <a href="https://cezarelnazli.github.io/mappedfile_soa.diff" target="_blank" title="https://cezarelnazli.github.io/mappedfile_soa.diff">here's the diff</a>. i'm looking for feedback</p>



<a name="129096089"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096089" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096089">(Jul 04 2018 at 17:22)</a>:</h4>
<p>in <code>struct bu_mapped_file</code>, i've added a pointer to the SoA of mapped files and the index of the mapped file in this SoA. i kept the old members so that functions working with a <code>struct bu_mapped_file</code> keep working (so i didn't remove the "old" API). however, now, when modifying a member in a <code>struct bu_mapped_file</code>, you also need to update it in the array (<code>tbl[idx]</code>)</p>



<a name="129096166"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096166" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096166">(Jul 04 2018 at 17:24)</a>:</h4>
<p>i don't know what the correct way of going about this is. new code still needs to be aware of the new API, and old code which writes to the array without using libbu's functions will become incorrect</p>



<a name="129096236"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096236" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096236">(Jul 04 2018 at 17:26)</a>:</h4>
<p>the is_active member is there for "deleting" in O(1). on the one hand it doesn't reuse array slots (which consumes a lot of memory), but on the other, deletions are faster (but i don't think there are many deletions of bu_mapped_files, so maybe it's better the other way)</p>



<a name="129096328"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096328" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096328">(Jul 04 2018 at 17:29)</a>:</h4>
<p><code>have_apbuf</code> is there because when realloc'ing the member arrays (e.g., <code>apbuf</code>), the new memory is not zero'd, so the old check <code>if (mp-&gt;apbuf)</code> does not work. so i'm using <code>have_apbuf</code>to keep track of whether the <code>apbuf</code> member is usable or not</p>



<a name="129096417"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096417" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096417">(Jul 04 2018 at 17:31)</a>:</h4>
<p>i think the flags (such as <code>is_active</code> and <code>have_apbuf</code>, and in this case, maybe <code>dont_restat</code> as well) can be put in an int of flags, although in this instance, the single chars occupy less memory</p>



<a name="129096591"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096591" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096591">(Jul 04 2018 at 17:36)</a>:</h4>
<p>when i want to add a new item to the array, that's 14 lines of very similar code doing very little. it's a bit tiresome to write and i think error-prone. don't really know what to do to it though, or if you care about this :-? maybe generate some macros at build time using python?</p>



<a name="129096611"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096611" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096611">(Jul 04 2018 at 17:37)</a>:</h4>
<p>i think the diff also includes changes to <code>bu_temp_file_list</code>. hmm... they're very similar</p>



<a name="129096666"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129096666" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129096666">(Jul 04 2018 at 17:38)</a>:</h4>
<p>also, indentation/white space is off. i didn't pass it through <code>ws.sh</code> since i'm just looking for feedback at this stage</p>



<a name="129287027"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129287027" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129287027">(Jul 08 2018 at 06:31)</a>:</h4>
<blockquote>
<p>i've done a first attempt of moving <code>bu_mappedfile</code> to SoA. <a href="https://cezarelnazli.github.io/mappedfile_soa.diff" target="_blank" title="https://cezarelnazli.github.io/mappedfile_soa.diff">here's the diff</a>. i'm looking for feedback</p>
</blockquote>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> what's the reason for duplicating the guts of bu_mapped_file in the _tbl instead of embedding an array of bu_mapped_file?</p>



<a name="129287132"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129287132" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129287132">(Jul 08 2018 at 06:35)</a>:</h4>
<p>we don't need to accommodate callers that directly access struct elements -- that is obviously a problem for backwards-compatibility.  a question to think through is how affected callers will be, whether they could/should be updated to go through accessor functions or if there's some good generalization etc.  another question is whether we can fix memory management while we're at it reworking the struct.  using the PIMPL pattern and accessing only via functions, it would be good to eliminate dynamic allocations (if at all possible).</p>



<a name="129287180"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129287180" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129287180">(Jul 08 2018 at 06:37)</a>:</h4>
<p>if you were to re-design bu_mappedfile and completely hid the implementation, what might that header file look like?</p>



<a name="129290246"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129290246" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129290246">(Jul 08 2018 at 08:35)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> what's the reason for duplicating the guts of bu_mapped_file in the _tbl instead of embedding an array of bu_mapped_file?</p>
</blockquote>
<p>i thought this is what moving to a structure of arrays meant, an array for each member of the struct. or do you mean having the member arrays inside bu_mapped_file and an array of bu_mapped_file in _tbl? i think i misunderstood something</p>



<a name="129290345"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129290345" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129290345">(Jul 08 2018 at 08:39)</a>:</h4>
<blockquote>
<p>we don't need to accommodate callers that directly access struct elements -- that is obviously a problem for backwards-compatibility.  a question to think through is how affected callers will be, whether they could/should be updated to go through accessor functions or if there's some good generalization etc.</p>
</blockquote>
<p>if i can replace code directly accessing members of bu_mapped_files with accessor functions, that would simplify the structs. i could make one bu_mapped_file be a pair of (pointer to tbl, idx in tbl) and it should be enough to implement the accessor functions. and i think the pair should be enough for all SoAs</p>



<a name="129290493"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129290493" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129290493">(Jul 08 2018 at 08:45)</a>:</h4>
<blockquote>
<p>another question is whether we can fix memory management while we're at it reworking the struct.  using the PIMPL pattern and accessing only via functions, it would be good to eliminate dynamic allocations (if at all possible).</p>
</blockquote>
<p>i'm not familiar with PIMPL, but from what i'm reading, it seems to decrease compilation times (since headers aren't modified so users of the header don't need to be recompiled) and help backwards-compatibility (even if we modify the implementation, the definitions the users see are the same). but i don't really see how i could eliminate dynamic allocations with this</p>



<a name="129290608"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129290608" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129290608">(Jul 08 2018 at 08:49)</a>:</h4>
<blockquote>
<p>if you were to re-design bu_mappedfile and completely hid the implementation, what might that header file look like?</p>
</blockquote>
<p>to start, i think the pair structure above and PIMPL for backwards-compatibility would be good. and there could be other things specific to bu_mapped_file that might be changed/improved</p>



<a name="129290651"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129290651" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129290651">(Jul 08 2018 at 08:50)</a>:</h4>
<p>but i'm still curious about this. seems like i misunderstood something about how to do SoA</p>
<blockquote>
<blockquote>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> what's the reason for duplicating the guts of bu_mapped_file in the _tbl instead of embedding an array of bu_mapped_file?</p>
</blockquote>
<p>i thought this is what moving to a structure of arrays meant, an array for each member of the struct. or do you mean having the member arrays inside bu_mapped_file and an array of bu_mapped_file in _tbl? i think i misunderstood something</p>
</blockquote>



<a name="129306879"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129306879" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129306879">(Jul 08 2018 at 16:54)</a>:</h4>
<blockquote>
<p>i thought this is what moving to a structure of arrays meant, an array for each member of the struct. or do you mean having the member arrays inside bu_mapped_file and an array of bu_mapped_file in _tbl? i think i misunderstood something</p>
</blockquote>
<p>It is both/either -- but what caught my eye is the duplication.  Maybe I misread the patch but it looked like there was a bu_mapped_file and a _tbl with pointers/arrays for all the same elements.</p>



<a name="129307000"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307000" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307000">(Jul 08 2018 at 16:59)</a>:</h4>
<p>there are a variety of ways to go about it, but one thing to be aware of is how memory is managed.  ideally, we want to avoid dynamic allocation for at least the typical use cases -- that is nearly always faster.  for something like a mapped file handle/table/list/set/etc where there are typically very few of them, we can avoid it very easily by creating a fixed size array, e.g., of size 8, and then falling back to dynamic allocation when that is exceeded.</p>



<a name="129307046"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307046" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307046">(Jul 08 2018 at 17:00)</a>:</h4>
<p>if you treat the struct as opaque and only access through functions, then we won't need to keep two public structs (one for the handle, one for arrays of them</p>



<a name="129307393"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307393" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307393">(Jul 08 2018 at 17:13)</a>:</h4>
<p>looking at the current mapped file public API, you should notice that it currently relies on some global state (e.g., notice how bu_free_mapped_files() somehow will free something it was not given) -- that's bad in itself but gets at the heart of how to convert bu_mappedfile to AoS or SoA or something else.  for example, there's nowhere in the public API (include/bu/mapped_file.h) that indicates an inherent need for there to be a list or set of bu_mappedfiles -- that is entirely a construct for the backend implementation that iterates over it's list of bu_mappedfiles to look for a match, to free them, etc</p>



<a name="129307440"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307440" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307440">(Jul 08 2018 at 17:14)</a>:</h4>
<p>that means in this specific instance, the "fix" for bu_list aliasing can be as simple as elimiate the bu_list in the struct and change the container in the implementation (bu_mapped_file_list in src/libbu/mappedfile.c)</p>



<a name="129307507"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307507" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307507">(Jul 08 2018 at 17:16)</a>:</h4>
<p>at that point, we could just convert it to an std::map (converting impl to c++) or use a plain C array and dynaimcally allocate more bu_mappedfiles as needed, keeping track of how many allocated and how many used.</p>



<a name="129307616"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307616" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307616">(Jul 08 2018 at 17:21)</a>:</h4>
<blockquote>
<p>i'm not familiar with PIMPL, but from what i'm reading, it seems to decrease compilation times (since headers aren't modified so users of the header don't need to be recompiled) and help backwards-compatibility (even if we modify the implementation, the definitions the users see are the same). but i don't really see how i could eliminate dynamic allocations with this</p>
</blockquote>
<p>pimpl doesn't eliminate dynamic allocation by itself, it just hides the implementation so you can change things more easily in the future.  it's not strictly necessary for bu_mappedfile, but would simplify memory management on the backend since the immediate goal really is just to eliminate the bu_list aliasing</p>



<a name="129307670"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129307670" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129307670">(Jul 08 2018 at 17:23)</a>:</h4>
<blockquote>
<blockquote>
<p>if you were to re-design bu_mappedfile and completely hid the implementation, what might that header file look like?</p>
</blockquote>
<p>to start, i think the pair structure above and PIMPL for backwards-compatibility would be good. and there could be other things specific to bu_mapped_file that might be changed/improved</p>
</blockquote>
<p>do you think you could write that header first? and any "hidden" structures that would live in the .c/.cpp implementation file?</p>



<a name="129391320"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129391320" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129391320">(Jul 10 2018 at 04:58)</a>:</h4>
<blockquote>
<p>if you treat the struct as opaque and only access through functions, then we won't need to keep two public structs (one for the handle, one for arrays of them</p>
</blockquote>
<p>yeah, i disliked the duplication in the structs as well. but i thought that it was ok for bu_mapped_file to bypass the API/functions, so i tried to keep the same members. i see that that's not necessary, i will make the changes</p>



<a name="129391343"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129391343" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129391343">(Jul 10 2018 at 04:59)</a>:</h4>
<p>you really can probably get away with just eliminating the bu_list in the public struct and then having a container of them in the implementation file</p>



<a name="129391347"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129391347" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129391347">(Jul 10 2018 at 04:59)</a>:</h4>
<p>now i also see what you mean about memory allocation and pimpl</p>



<a name="129391359"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129391359" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129391359">(Jul 10 2018 at 04:59)</a>:</h4>
<p>that addresses the immediate issue (aliasing of bu_list) ... and there are dozens of other bu_list to tackle next ;)</p>



<a name="129391424"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129391424" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129391424">(Jul 10 2018 at 05:00)</a>:</h4>
<p>yep :D i'll make the changes after i'm done tracking the rtwizard bug</p>



<a name="129739596"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129739596" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129739596">(Jul 16 2018 at 09:34)</a>:</h4>
<p>regarding the api, i was thinking of something similar to getsockopt/setsockopt, so instead of having lots of functions like<br>
<code>bu_mappedfile_set/get_dont_restat(struct mapped_file *[, int new_val])</code><br>
for each member, we could just have two functions<br>
<code>bu_mappedfile_set/get(struct mapped_file *, member_enum_t which_member[, void *new_val])</code></p>



<a name="129739695"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129739695" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129739695">(Jul 16 2018 at 09:37)</a>:</h4>
<p>with something like that, i think it can even be abstracted further, having a generic setter/getter, and enums + callbacks  for specific structs</p>



<a name="129752923"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129752923" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129752923">(Jul 16 2018 at 14:29)</a>:</h4>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> that'd be great except it's punting on API design and would introduce a runtime crash potential (incorrect void *marshaling) -- they don't necessarily need access to every field we previous had in a struct mappedfile.</p>



<a name="129753179"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753179" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753179">(Jul 16 2018 at 14:33)</a>:</h4>
<p>going down the list, 'l' can simply be eliminated (and thus we're done with this struct from an aliasing perspective) because the .c/.cpp file can simply hold a list/array of them, accessed via 'name'+'appl'.  you'd hide all the implementation fields via pimpl with a backend struct, which is 'buf', 'buflen', 'is_mapped', 'modtime', 'uses', and 'dont_restart'.  that leaves just 'apbuf' and 'abbuflen' which is user data that should be set/got via function.</p>



<a name="129753265"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753265" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753265">(Jul 16 2018 at 14:35)</a>:</h4>
<p>for added measure, I'll note mapped_file doesn't conform with hacking on the LIB_GROUP_...() naming convention -- it's one of the older apis that needs to be cleaned up</p>



<a name="129753361"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753361" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753361">(Jul 16 2018 at 14:36)</a>:</h4>
<p>regardless, I wouldn't get too wrapped around the axel on mapped_file API ... that was supposed to be just a quick one for addressing the bu_list aliasing.  there are literally dozens of these and not time to spend days on each thinking about all the ways they could be improved... :)</p>



<a name="129753403"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753403" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753403">(Jul 16 2018 at 14:37)</a>:</h4>
<p>the fix for struct bu_mapped_file is to just remove the bu_list and make the backend track them differently.  I'd probably just make a plain array that holds N of them and then have a dynamic array that is realloced if we exceed N</p>



<a name="129753419"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753419" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753419">(Jul 16 2018 at 14:37)</a>:</h4>
<p>i think most of what we discuss about mapoed_file can be carried over to the more central structures</p>



<a name="129753504"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753504" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753504">(Jul 16 2018 at 14:38)</a>:</h4>
<p>i understand what you’re saying about just removing ‘l’, but i don‘t think that would carry over as well to the other structs</p>



<a name="129753509"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753509" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753509">(Jul 16 2018 at 14:39)</a>:</h4>
<p>that is true</p>



<a name="129753513"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753513" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753513">(Jul 16 2018 at 14:39)</a>:</h4>
<p>but so what? :)</p>



<a name="129753539"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753539" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753539">(Jul 16 2018 at 14:39)</a>:</h4>
<p>we're not necessarily looking for a universal solution, at least if we were -- it would be how to replace bu_list</p>



<a name="129753620"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753620" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753620">(Jul 16 2018 at 14:40)</a>:</h4>
<p>but that's specifically not possible in any meaningful way because of how bu_list was designed -- it's too abstract and used in <em>very</em> different ways throughout the code</p>



<a name="129753660"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753660" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753660">(Jul 16 2018 at 14:41)</a>:</h4>
<p>that's why the original exercise was to just tackle one struct like mapped_file, then do another, and another, to see if there's a common pattern that might warrant API</p>



<a name="129753674"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753674" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753674">(Jul 16 2018 at 14:41)</a>:</h4>
<p>with mapped_file, the best solution is elimination of the bu_list ... that doesn't imply more API</p>



<a name="129753749"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753749" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753749">(Jul 16 2018 at 14:42)</a>:</h4>
<p>the common pattern might just be to eliminate bu_list everywhere and convert all the .c files to .cpp files with std:: containers</p>



<a name="129753812"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129753812" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129753812">(Jul 16 2018 at 14:43)</a>:</h4>
<p>do you remember what problem is being tackled?</p>



<a name="129754051"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754051" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754051">(Jul 16 2018 at 14:47)</a>:</h4>
<p>well, i thought that the point was eliminating bu_list altogether with the goal of improving cache behaviour</p>



<a name="129754063"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754063" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754063">(Jul 16 2018 at 14:47)</a>:</h4>
<p>i think i was wrong about the first part though :D</p>



<a name="129754134"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754134" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754134">(Jul 16 2018 at 14:48)</a>:</h4>
<p>the problem being tackled is automatic vectorization</p>



<a name="129754147"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754147" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754147">(Jul 16 2018 at 14:48)</a>:</h4>
<p>by the compiler</p>



<a name="129754168"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754168" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754168">(Jul 16 2018 at 14:48)</a>:</h4>
<p>automatic vectorization is disabled by certain things -- pointer aliasing is one of them</p>



<a name="129754190"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754190" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754190">(Jul 16 2018 at 14:49)</a>:</h4>
<p>bu_list's are commonly aliased (hence why they are always the first struct element)</p>



<a name="129754311"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754311" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754311">(Jul 16 2018 at 14:50)</a>:</h4>
<p>it's also a very old method that is unfamiliar to most C/C++ programmers coming right out of school, which makes API and code hard to understand</p>



<a name="129754339"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754339" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754339">(Jul 16 2018 at 14:51)</a>:</h4>
<p>AND the code is potentially cache incoherent, but that depends on how bu_list was used</p>



<a name="129754556"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754556" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754556">(Jul 16 2018 at 14:54)</a>:</h4>
<p>oh, ok, i see i did forget the initial goal</p>



<a name="129754572"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754572" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754572">(Jul 16 2018 at 14:54)</a>:</h4>
<p>by a quick count, there are 139 bu_list instances in our public API...</p>



<a name="129754632"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754632" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754632">(Jul 16 2018 at 14:55)</a>:</h4>
<p>i understand how bu_list aliasing works, and i did use it previously, it’s what happens with some sockets structs too, but i never thought about vectorization and their performance implications</p>



<a name="129754633"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754633" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754633">(Jul 16 2018 at 14:55)</a>:</h4>
<p>rather, 153,  but only 139 that matter</p>



<a name="129754744"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754744" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754744">(Jul 16 2018 at 14:57)</a>:</h4>
<p>so <span class="user-mention" data-user-id="106398">@Cezar</span> ... we're past the second evaluation.  I think it's time for a step back regardless.</p>



<a name="129754857"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754857" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754857">(Jul 16 2018 at 14:58)</a>:</h4>
<p>oh, and before going down that route -- just add that there look to be at least 53 of those 139 in libbu, at least per the original project scope ;)</p>



<a name="129754880"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754880" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754880">(Jul 16 2018 at 14:59)</a>:</h4>
<p>okay, so taking a step back -- if you could do anything, work on anything -- what would that be?</p>



<a name="129754907"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129754907" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129754907">(Jul 16 2018 at 14:59)</a>:</h4>
<p>forgetting about bu_lists for a moment</p>



<a name="129755331"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129755331" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129755331">(Jul 16 2018 at 15:04)</a>:</h4>
<p>well, ideally on something that offers the most performance gains</p>



<a name="129755389"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129755389" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129755389">(Jul 16 2018 at 15:05)</a>:</h4>
<p>i started on this because you said at some point that it would improve performance by an order of magnitute, so it was appealing</p>



<a name="129756406"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756406" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756406">(Jul 16 2018 at 15:19)</a>:</h4>
<p>heh, well that's good to hear :)</p>



<a name="129756468"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756468" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756468">(Jul 16 2018 at 15:20)</a>:</h4>
<p>so sticking with performance, the problem with getting that order is the workload</p>



<a name="129756504"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756504" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756504">(Jul 16 2018 at 15:20)</a>:</h4>
<p>the gain cannot happen until some subset of the 139 (the ones involved in ray tracing) have aliasing eliminated</p>



<a name="129756658"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756658" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756658">(Jul 16 2018 at 15:22)</a>:</h4>
<p>but it's undeniably a lot of work.  at this rate, you'd need to do about one bu_list per hour, or at least 5-10 per day to get there before gsoc is over (~17 days)</p>



<a name="129756697"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756697" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756697">(Jul 16 2018 at 15:23)</a>:</h4>
<p>and that seems unlikely given the first one has been about 2+ weeks  :)</p>



<a name="129756779"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756779" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756779">(Jul 16 2018 at 15:25)</a>:</h4>
<p>that's not saying anything negative about you <span class="user-mention" data-user-id="106398">@Cezar</span> ... the first ones when going down a new development route will always take the longest.  the question I have for you is whether now that you've learned so much about this is whether to keep running this route or change things up.</p>



<a name="129756821"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129756821" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129756821">(Jul 16 2018 at 15:26)</a>:</h4>
<p>to stay the path, it's going to be a race against time and you'll probably want to install the Intel compiler (as it has outstanding vectorization/aliasing reporting)</p>



<a name="129757020"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129757020" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129757020">(Jul 16 2018 at 15:28)</a>:</h4>
<p>alternatively, there is a performance gain to be had in a few other specific places like boolean evaluation, ray dispatching, and perceptively via display presentation</p>



<a name="129757037"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129757037" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129757037">(Jul 16 2018 at 15:28)</a>:</h4>
<p>there's probably just enough time to make progress in just one area</p>



<a name="129786229"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129786229" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129786229">(Jul 17 2018 at 01:05)</a>:</h4>
<blockquote>
<p>that's not saying anything negative about you <span class="user-mention" data-user-id="106398">@Cezar</span> ... the first ones when going down a new development route will always take the longest.  the question I have for you is whether now that you've learned so much about this is whether to keep running this route or change things up.</p>
</blockquote>
<p><span class="user-mention" data-user-id="102902">@Sean</span>  well, i can't really say i've learnt much. i was aware of most of what i've done, but the reason it took so much was that i hit three bugs (the deadlock, the compilation issue, and the failing tests on the mac) unrelated to the SoA work which have taken a lot of time to fix</p>



<a name="129786301"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129786301" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129786301">(Jul 17 2018 at 01:07)</a>:</h4>
<p>it may be my fault because i've managed the time incorrectly (i also spent a week reading something that didn't offer much return), but there wasn't much figuring out with regards to bu_mappedfile</p>



<a name="129786431"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129786431" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129786431">(Jul 17 2018 at 01:10)</a>:</h4>
<blockquote>
<p>to stay the path, it's going to be a race against time and you'll probably want to install the Intel compiler (as it has outstanding vectorization/aliasing reporting)</p>
</blockquote>
<p>installing the intel compiler is not a hurdle (i think), but i did not know that it had outstanding vectorization reporting. when i started this part of the work, i did use vectorization reporting, albeit from clang. i recognized it would be useful, but i think i (mis)understood from one of your messages back then that i shouldn't (need to?) do that :-?</p>



<a name="129786479"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129786479" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129786479">(Jul 17 2018 at 01:11)</a>:</h4>
<blockquote>
<p>alternatively, there is a performance gain to be had in a few other specific places like boolean evaluation, ray dispatching, and perceptively via display presentation</p>
</blockquote>
<p>if you think it would be better to switch focus, i would be fine. but i think it would be useful for me to have an outline of the work that i should do for these specific places. i can't tell you right now i would like to work on boolean evaluation because i don't know what exactly that would entail (and similarly for the other two areas)</p>



<a name="129786556"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129786556" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129786556">(Jul 17 2018 at 01:13)</a>:</h4>
<p>another fault on my part would be that i should've asked for an outline (or how you would see it) when i first started, but i thought i could figure it out as i went along, so i've mostly proceeded without a plan/overview of where i should be heading</p>



<a name="129788012"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129788012" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129788012">(Jul 17 2018 at 01:52)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="102902">@Sean</span>  well, i can't really say i've learnt much. i was aware of most of what i've done, but the reason it took so much was that i hit three bugs (the deadlock, the compilation issue, and the failing tests on the mac) unrelated to the SoA work which have taken a lot of time to fix</p>
</blockquote>
<p>hm, that is true.  there have been a number of annoying issues. several still unresolved to bite another day. :(</p>



<a name="129788044"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129788044" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129788044">(Jul 17 2018 at 01:53)</a>:</h4>
<p>was the deadlock the gga issue or something else?  I know there's a workaround on the compilation (i.e., leave the turn-off inlining flag for now), and punting on the rtwizard bug until someone else can find the commit that caused it.</p>



<a name="129788209"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129788209" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129788209">(Jul 17 2018 at 01:59)</a>:</h4>
<blockquote>
<p>installing the intel compiler is not a hurdle (i think), but i did not know that it had outstanding vectorization reporting. when i started this part of the work, i did use vectorization reporting, albeit from clang. i recognized it would be useful, but i think i (mis)understood from one of your messages back then that i shouldn't (need to?) do that :-?</p>
</blockquote>
<p>installing it is easy -- you can just say you're using it with BRL-CAD as open source use gets a free license key.  you don't <em>need</em> to use the vectorization reporting until you've taken care of all the higher level issues OR if you're working on optimizing a very specific piece of code.  In talking about making a major impact on ray tracing performance, you could for example find all of the files with the hotest functions and make sure just those files pass automatic vectorization.  that would be FAR fewer of the 139 bu_list instances, for example -- a prioritization aid that would directly pertain to performance.</p>



<a name="129788321"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129788321" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129788321">(Jul 17 2018 at 02:02)</a>:</h4>
<p>I don't really think you should switch focus -- I'm just trying to make sure the work stays interesting to you.  could be wrong, but it just felt to me like you were getting tired of the bu_list work.  the fact that you've said you're not learning much reflects that too.  if it's still interesting and something you want to do, then you're still good to go from my perspective.  we need bu_list to go away either way. :)</p>



<a name="129788481"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129788481" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129788481">(Jul 17 2018 at 02:08)</a>:</h4>
<blockquote>
<p>another fault on my part would be that i should've asked for an outline (or how you would see it) when i first started, but i thought i could figure it out as i went along, so i've mostly proceeded without a plan/overview of where i should be heading</p>
</blockquote>
<p>to be honest, I was (and still am) fine with you proceeding without an outline or specific plan too because I know you're capable and there's so many ways you can make the code better.  that of course is a double-edged sword because some places in the code are FAR more important than others -- for example, bu_mappedfile is completely unimportant in the big scheme of things other than as a learning struct for getting rid of bu_list.  that's why I've been suggesting the shortest route possible -- just remove it and make the backend use a container.  the important structs <em>are</em> going to be hard, which is why they really shouldn't be tackled first.  we must all learn the issues and patterns involved from some of the 138 other instances.</p>



<a name="129788894"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129788894" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129788894">(Jul 17 2018 at 02:21)</a>:</h4>
<p>you know what might help is seeing ray tracing performance at a much lower level.  i'll send you a link for something you can try running.</p>



<a name="129811930"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129811930" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129811930">(Jul 17 2018 at 13:15)</a>:</h4>
<blockquote>
<p>was the deadlock the gga issue or something else?</p>
</blockquote>
<p>not sure what a gga issue is :D</p>



<a name="129812716"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129812716" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129812716">(Jul 17 2018 at 13:30)</a>:</h4>
<blockquote>
<p>I don't really think you should switch focus -- I'm just trying to make sure the work stays interesting to you.  could be wrong, but it just felt to me like you were getting tired of the bu_list work.  the fact that you've said you're not learning much reflects that too.  if it's still interesting and something you want to do, then you're still good to go from my perspective.  we need bu_list to go away either way. <span class="emoji emoji-1f603" title="smiley">:smiley:</span></p>
</blockquote>
<p>it's not that i got tired of the bu_list work, but debugging those problems was interesting enough to give it a try and i thought it would take less time, so that's why i spent more time there</p>



<a name="129866166"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129866166" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129866166">(Jul 18 2018 at 11:30)</a>:</h4>
<p><span class="user-mention" data-user-id="102902">@Sean</span>  i generated a report using intel's compiler (<a href="/user_uploads/1549/F7Ew3__ugUPoGCp2HKr-uoxD/bool.c.optrpt" target="_blank" title="bool.c.optrpt">bool.c.optrpt</a>). it seems like a lot of the loops can't be vectorized because of the control flow (from what i gather, it means things like continue/goto/break)</p>



<a name="129866194"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129866194" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129866194">(Jul 18 2018 at 11:31)</a>:</h4>
<p>and in terms of structures, i think <code>struct partition</code> is the one involved in most of the report, so should i start looking at getting rid of bu_list there?</p>



<a name="129866263"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129866263" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129866263">(Jul 18 2018 at 11:33)</a>:</h4>
<p>also, i had to disable Werror when compiling with icc (it complained about things like <code>assert(a &gt; b &amp;&amp; "a is not bigger than b")</code>), and 10+ tests are failing. i don't know if icc is important though</p>



<a name="129868528"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129868528" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129868528">(Jul 18 2018 at 12:24)</a>:</h4>
<p>actually, it's not 10+, i misremembered. tried it again, it's 3 (rt_dvec, regress-solids, and the rtwizard D one)</p>



<a name="129872981"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/129872981" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#129872981">(Jul 18 2018 at 13:57)</a>:</h4>
<p>i committed the code eliminating bu_list from libbu/temp.c. if issues arise, i'll fix them, but the changes should be easier to follow this way</p>



<a name="130083529"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130083529" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130083529">(Jul 22 2018 at 05:23)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="102902">@Sean</span>  i generated a report using intel's compiler (<a href="/user_uploads/1549/F7Ew3__ugUPoGCp2HKr-uoxD/bool.c.optrpt" target="_blank" title="bool.c.optrpt">bool.c.optrpt</a>). it seems like a lot of the loops can't be vectorized because of the control flow (from what i gather, it means things like continue/goto/break)</p>
</blockquote>
<p>Yep, there are a handful of other issues also affecting auto-vectorization, not just aliasing.  Aliasing is just one of the more spread out issues that will take time to resolve.  Some of the other issues are being tackled in different ways or require back-porting -- e.g., the control flow issues are already mostly fixed in the OpenCL code path.</p>



<a name="130083580"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130083580" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130083580">(Jul 22 2018 at 05:25)</a>:</h4>
<blockquote>
<p>and in terms of structures, i think <code>struct partition</code> is the one involved in most of the report, so should i start looking at getting rid of bu_list there?</p>
</blockquote>
<p>I not without experience with a lot more bu_list patterns... partition is one of the ones that is going to be considerably harder for both technical and practical reasons (changing the structure without introducing API will break essentially all critical applications).</p>



<a name="130083629"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130083629" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130083629">(Jul 22 2018 at 05:27)</a>:</h4>
<blockquote>
<p>i committed the code eliminating bu_list from libbu/temp.c. if issues arise, i'll fix them, but the changes should be easier to follow this way</p>
</blockquote>
<p>this is in my commit-queue to review, so I'll let you know if I see any issues!  saw the other that followed as well.  Keep at them. ;)</p>



<a name="130083680"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130083680" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130083680">(Jul 22 2018 at 05:29)</a>:</h4>
<p>any modern popular compiler is worth fixing, if you want to tackle the issues.  just beware of red herrings -- issues that seem like one thing but are really another.  example, assert() warnings could very well be just because some other bit of CMake logic is wrong and not because there's anything actually wrong with the assert line.  Be skeptical and confirm the source, not just patch symptoms, is the healthy perspective to have.</p>



<a name="130083733"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130083733" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130083733">(Jul 22 2018 at 05:31)</a>:</h4>
<p>of course, it's secondary to the other work, so you're welcome to disable warnings and proceed if fixing them is not interesting</p>



<a name="130113349"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130113349" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130113349">(Jul 22 2018 at 20:28)</a>:</h4>
<blockquote>
<p>I not without experience with a lot more bu_list patterns... partition is one of the ones that is going to be considerably harder for both technical and practical reasons (changing the structure without introducing API will break essentially all critical applications).</p>
</blockquote>
<p>oh, i wasn't sure if you wanted me to focus on the central structures. so should i just keep on eliminating bu_list from the files that are easier? regarding the API, i see what you mean. i'm thinking of maybe getting rid of bu_list in the internal code and exposing the old way to the users, but i don't really have experience with deprecating things (or even designing APIs, but i think i have some overall ideas about that)</p>



<a name="130113374"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130113374" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130113374">(Jul 22 2018 at 20:28)</a>:</h4>
<blockquote>
<p>this is in my commit-queue to review, so I'll let you know if I see any issues!  saw the other that followed as well.  Keep at them. ;)</p>
</blockquote>
<p>i'm curious, is there a tool for keeping a commit queue, or do you just take note of them and go over them at a later time?</p>



<a name="130113463"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130113463" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130113463">(Jul 22 2018 at 20:30)</a>:</h4>
<blockquote>
<p>any modern popular compiler is worth fixing, if you want to tackle the issues.  just beware of red herrings -- issues that seem like one thing but are really another.  example, assert() warnings could very well be just because some other bit of CMake logic is wrong and not because there's anything actually wrong with the assert line.  Be skeptical and confirm the source, not just patch symptoms, is the healthy perspective to have.</p>
</blockquote>
<p>i see what you mean. i'll keep that in mind when facing issues like that. i think i should've done that with the gcc 6.3 bug as well</p>



<a name="130113480"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130113480" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130113480">(Jul 22 2018 at 20:30)</a>:</h4>
<blockquote>
<p>of course, it's secondary to the other work, so you're welcome to disable warnings and proceed if fixing them is not interesting</p>
</blockquote>
<p>disabling Werror is what i've done so far in order to generate the reports</p>



<a name="130134948"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130134948" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130134948">(Jul 23 2018 at 07:52)</a>:</h4>
<p>in libbu, i found 6 files exposing an API which uses <code>bu_list</code></p>
<div class="codehilite"><pre><span></span>include/bu % grep -Rl &quot;bu_list&quot; .
./observer.h
./bitv.h
./hook.h
./ptbl.h
./redblack.h
./list.h
./cmd.h
</pre></div>



<a name="130135130"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130135130" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130135130">(Jul 23 2018 at 07:58)</a>:</h4>
<p><span class="user-mention" data-user-id="102902">@Sean</span> i was considering removing bu_list from them going forward (and after that moving on to librt), but since they're user-facing structures, what i would do is leave the bu_list member in place, modify existing code to not use the bu_list, and mark it as deprecated somehow</p>



<a name="130162068"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130162068" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130162068">(Jul 23 2018 at 17:33)</a>:</h4>
<blockquote>
<p>i'm curious, is there a tool for keeping a commit queue, or do you just take note of them and go over them at a later time?</p>
</blockquote>
<p>I have a tool I use for this, but it's very specific to my workflow needs -- not something generally reusable.  For team review, we've talked about using either Crucible or Phabricator but nobody has gone through the effort to set it up.</p>



<a name="130162496"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130162496" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130162496">(Jul 23 2018 at 17:40)</a>:</h4>
<p>that plan sounds good -- you can mark them deprecated in a doxygen comment, e.g., /***&lt; DEPRECATED */</p>



<a name="130162526"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130162526" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130162526">(Jul 23 2018 at 17:41)</a>:</h4>
<p>if there are no places in our code that actually iterate the list, it might even be possible to remove the element without deprecation but that will have to be a case-by-case judgement call -- ask me if you find any like that</p>



<a name="130181273"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130181273" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130181273">(Jul 24 2018 at 00:12)</a>:</h4>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> I looked through that list in libbu and looks like observer, hook, redblack, and cmd.h can easily just be changed/removed.  bitv, ptbl, and list are definitely harder as they are prominently used by applications, but if you can change them such that the places where code calls them is only minimally impacted, then they could be changed too.</p>



<a name="130181287"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130181287" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130181287">(Jul 24 2018 at 00:13)</a>:</h4>
<p>minimally impacted means you could fix the code that calls them with a simple stateless regular expression (typically fixing calling code with a search-and-replace)</p>



<a name="130181296"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130181296" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130181296">(Jul 24 2018 at 00:13)</a>:</h4>
<p>that may or may not be doable with the three harder ones.</p>



<a name="130810102"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130810102" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130810102">(Aug 03 2018 at 00:47)</a>:</h4>
<p>i have something which builds, but i can't run <code>make test</code> because of the <code>result</code> problem i mentioned previously. should i commit? submit a patch?</p>



<a name="130816167"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130816167" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130816167">(Aug 03 2018 at 03:47)</a>:</h4>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> you have commit, so you no longer need to submit to the patch tracker unless you just really really really want to ...</p>



<a name="130816213"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130816213" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130816213">(Aug 03 2018 at 03:48)</a>:</h4>
<p>it's just as easy to check it post commit and fix or revert if needed -- if you want me or someone else to check it beforehand, just post up patch</p>



<a name="130908143"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/130908143" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#130908143">(Aug 04 2018 at 23:48)</a>:</h4>
<p>i've committed the removal of bu_list from the simpler ones. i tried to be careful since i can't really run all the tests, hope everything is ok. should i look at bitv/ptbl next?</p>



<a name="131136263"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136263" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136263">(Aug 08 2018 at 22:29)</a>:</h4>
<p>i'm trying to remove the bu_list in bu_ptbl. in some places, a list of <code>bu_ptbl</code>s is still needed. should i implement a dynamically-expanded array like i did for the other replacements, or should i use std::array? the reason i'm asking is because i don't know if the plan is to switch to STL eventually, and if it is, i think i should use it now instead of postponing</p>



<a name="131136434"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136434" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136434">(Aug 08 2018 at 22:33)</a>:</h4>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> before going down that road, we need more unit tests...</p>



<a name="131136561"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136561" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136561">(Aug 08 2018 at 22:35)</a>:</h4>
<p>what should they test for? that the structures using the new list behave the same as with the bu_list?</p>



<a name="131136587"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136587" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136587">(Aug 08 2018 at 22:36)</a>:</h4>
<p>Found three separate bugs in bu_hook today from its conversion and there’s a couple higher level integration tests failing now, likely from the other conversions (memory corruption)</p>



<a name="131136740"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136740" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136740">(Aug 08 2018 at 22:38)</a>:</h4>
<p>They should ideally test each of the public functions, testing that good inputs do what is expected and bad fails appropriate</p>



<a name="131136774"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136774" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136774">(Aug 08 2018 at 22:39)</a>:</h4>
<p>after making the changes, i ran <code>make test</code> and everything passed, except for the rtwizard ones. how do i run the high level integration tests?</p>



<a name="131136921"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136921" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136921">(Aug 08 2018 at 22:42)</a>:</h4>
<p>That’s good, though the nature of container bugs can be super hard to trigger</p>



<a name="131136952"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131136952" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131136952">(Aug 08 2018 at 22:43)</a>:</h4>
<p>With memory corruption, it’ll work fine with one compile and not another</p>



<a name="131137027"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131137027" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131137027">(Aug 08 2018 at 22:45)</a>:</h4>
<p>That’s where cross platform testing helps, in general, as memory tends to be arranged quite different</p>



<a name="131137113"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131137113" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131137113">(Aug 08 2018 at 22:47)</a>:</h4>
<p>One thing you can check easily is distcheck-full</p>



<a name="131137165"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131137165" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131137165">(Aug 08 2018 at 22:48)</a>:</h4>
<p>That will at least check optimized which should disable zero-initialization</p>



<a name="131157596"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131157596" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cezar <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131157596">(Aug 09 2018 at 08:15)</a>:</h4>
<p>do you have any suggestions for what files i should write tests for?</p>



<a name="131157981"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131157981" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131157981">(Aug 09 2018 at 08:24)</a>:</h4>
<blockquote>
<p>do you have any suggestions for what files i should write tests for?</p>
</blockquote>
<p>er, the ones you modified...</p>



<a name="131158132"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131158132" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131158132">(Aug 09 2018 at 08:28)</a>:</h4>
<p>I'd suggest starting with bu_hook -- it should be dead easy.  you'll notice a variety of testing patterns in src/libbu/tests -- feel free to pick your preference or come up with something on your own, just try to keep things as simple and obvious as possible.  Clever tests can be a bear to debug.</p>



<a name="131158332"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131158332" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131158332">(Aug 09 2018 at 08:32)</a>:</h4>
<p>then redblack, observers</p>



<a name="131158368"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131158368" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131158368">(Aug 09 2018 at 08:33)</a>:</h4>
<p>at a glance, fb_obj looks like it may have a lot of the same problems as bu_hook had ... didn't check the others that closely yet</p>



<a name="131158452"></a>
<h4><a href="https://brlcad.zulipchat.com#narrow/stream/111975-Google%20Summer%20of%20Code/topic/SoA/near/131158452" class="zl"><img src="https://brl-cad.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sean <a href="https://brl-cad.github.io/zulip_archive/stream/111975-Google-Summer-of-Code/topic/SoA.html#131158452">(Aug 09 2018 at 08:35)</a>:</h4>
<p><span class="user-mention" data-user-id="106398">@Cezar</span> it would also be good to carve out a solid day to write up a summary report of everything you worked on, improved, maybe one last round of profiles  (even if just to comment how all this foundation stuff doesn't affect performance yet until all bu_lists are gone)</p>



<hr><p>Last updated: Aug 20 2025 at 00:53 UTC</p>
</html>