[
    {
        "content": "<p>Anyone else seeing distcheck-full errors on main?  I'm getting a handful that look like valid bugs:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>...\n 35/922 Test  #33: bu_file ....................................................***Failed    0.01 sec\n\nfile [FAIL] test input file bu_file_test_dir/bu_file_1 is incorrectly reported to be executable\n...\n373/922 Test #374: bu_color_to_rgb_floats_1 ...................................***Failed    0.00 sec\nResult: 0.752941,0.305882,0.839216\n...\nStart 922: ged_test_drawing_quad\n919/922 Test #922: ged_test_drawing_quad ......................................Subprocess aborted***Exception:   0.00 sec\ndyld[94599]: Library not loaded: @executable_path/../lib/libtcl8.6.dylib\n  Referenced from: &lt;77324E71-4FC8-3FA9-B662-6DD9330C4344&gt; /Volumes/X10/brlcad/.build.debug/distcheck-in_src_dir/brlcad-7.40.1/src/libged/tests/draw/ged_test_quad\n  Reason: tried: '/Volumes/X10/brlcad/.build.debug/distcheck-in_src_dir/brlcad-7.40.1/src/libged/tests/lib/libtcl8.6.dylib' (no such file)\n\n920/922 Test #907: rt_cache_serial_multiple_different_objects .................   Passed    7.23 sec\n921/922 Test #555: bu_mappedfile_serial_16384 .................................   Passed  100.26 sec\n922/922 Test #556: bu_mappedfile_parallel_16384 ...............................   Passed  120.57 sec\n\n99% tests passed, 12 tests failed out of 922\n\nTotal Test time (real) = 125.61 sec\n\nThe following tests FAILED:\n         33 - bu_file (Failed)\n        374 - bu_color_to_rgb_floats_1 (Failed)\n        910 - rt_search_tests (Subprocess aborted)\n        914 - ged_test_tops_moss (Subprocess aborted)\n        915 - ged_test_list (Subprocess aborted)\n        916 - ged_test_material (Subprocess aborted)\n        917 - ged_test_search (Subprocess aborted)\n        918 - ged_test_drawing_basic (Subprocess aborted)\n        919 - ged_test_drawing_faceplate (Subprocess aborted)\n        920 - ged_test_drawing_lod (Subprocess aborted)\n        921 - ged_test_drawing_select (Subprocess aborted)\n        922 - ged_test_drawing_quad (Subprocess aborted)\nErrors while running CTest\n</code></pre></div>\n<p>First two look like bugs, subprocess looks to be maybe something wrong in the relocatability dylib/exec editing.</p>",
        "id": 455712803,
        "sender_full_name": "Sean",
        "timestamp": 1722533448
    },
    {
        "content": "<p>I've not seen those errors - are they only in the in-src-dir config or do they pop up in others as well?</p>",
        "id": 455731489,
        "sender_full_name": "starseeker",
        "timestamp": 1722538355
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112516\">@starseeker</span> I just ran distcheck-full… didn’t see any other errors.  I haven’t just run a plain distcheck too but was going to check that also.</p>",
        "id": 455760039,
        "sender_full_name": "Sean",
        "timestamp": 1722547910
    },
    {
        "content": "<p>Just an update, ran make check and the errors are agnostic.  Fails debug and release on those tests, so something newish.</p>",
        "id": 455794065,
        "sender_full_name": "Sean",
        "timestamp": 1722560873
    },
    {
        "content": "<p>Failures are also on RELEASE branch just the same. </p>\n<p>Looking into the lib issues, looks like it's because the unit tests are wired wrong, as if they were installed into bin:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>morrison@Miniagua tests % ./ged_test_tops\ndyld[47269]: Library not loaded: @executable_path/../lib/libtcl8.6.dylib\n  Referenced from: &lt;82312D51-F510-33AC-9283-067C3FBAFF54&gt; /Volumes/X10/brlcad.RELEASE/.build.release/src/libged/tests/ged_test_tops\n  Reason: tried: '/Volumes/X10/brlcad.RELEASE/.build.release/src/libged/lib/libtcl8.6.dylib' (no such file)\nzsh: abort      ./ged_test_tops\nmorrison@Miniagua tests % DYLD_LIBRARY_PATH=../../../lib ./ged_test_tops\nUsage: ./ged_test_tops file.g\nmorrison@Miniagua tests % otool -L ./ged_test_tops\n./ged_test_tops:\n    @rpath/libged.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libanalyze.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libwdb.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/liboptical.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @executable_path/../lib/libtcl8.6.dylib (compatibility version 8.6.0, current version 8.6.14)\n    @rpath/libdm.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libicv.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libnetpbm.dylib (compatibility version 0.0.0, current version 0.0.0)\n    @rpath/libutahrle.19.dylib (compatibility version 19.0.0, current version 19.0.1)\n    @rpath/librt.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libbrep.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libnmg.dylib (compatibility version 0.0.0, current version 0.0.0)\n    @rpath/libbv.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libbg.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libbn.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libOpenNURBS.dylib (compatibility version 0.0.0, current version 0.0.0)\n    @rpath/libmanifold.2.dylib (compatibility version 2.0.0, current version 2.4.5)\n    @rpath/libassimp.5.dylib (compatibility version 5.0.0, current version 5.4.1)\n    @rpath/libgeogram.1.dylib (compatibility version 1.0.0, current version 1.9.0)\n    @rpath/libpkg.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    @rpath/libbu.20.dylib (compatibility version 20.0.0, current version 20.0.1)\n    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1336.61.1)\n    @rpath/png.framework/Versions/1.6.43/png (compatibility version 0.0.0, current version 0.0.0)\n    @rpath/libz_brl.1.dylib (compatibility version 1.0.0, current version 1.3.1)\n    @rpath/liblmdb.dylib (compatibility version 0.0.0, current version 0.0.0)\n    @rpath/libregex_brl.1.dylib (compatibility version 1.0.0, current version 1.0.4)\nmorrison@Miniagua tests % pwd\n/Volumes/X10/brlcad.RELEASE/.build.release/src/libged/tests\n</code></pre></div>",
        "id": 455840434,
        "sender_full_name": "Sean",
        "timestamp": 1722578903
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"112516\">@starseeker</span> investigated the dyld issue a few hours and don't understand why libtcl is being changed/installed with a @executable_path into the lib.  Do you recall why? </p>\n<p>That seems to fundamentally be the issue.  If I replace @executable_path/../lib/libtcl8.6.dylib with @rpath/libtcl8.6.dylib like all the other libs, it works just fine.  I had to replace them in libtcl itself as well as all the libs and apps that link tcl, but presumably they're inheriting from libtcl's original setting.</p>\n<p>I found the section in the patch file where you override it, but wanted to check why before mucking with it.</p>",
        "id": 456036621,
        "sender_full_name": "Sean",
        "timestamp": 1722630253
    },
    {
        "content": "<p>At a guess I probably was using the settings from elsewhere in our build, and didn't properly clue in that I needed to go that route for libtcl</p>",
        "id": 456053022,
        "sender_full_name": "starseeker",
        "timestamp": 1722637674
    },
    {
        "content": "<p>No other library appears to have/do that.. don't see it anywhere else, but maybe I'm missing it.  That's why I was wondering why you have that specific patch being applied to Tcl's build logic, to make it use @executable_path.</p>",
        "id": 456109002,
        "sender_full_name": "Sean",
        "timestamp": 1722664211
    },
    {
        "content": "<p>I don't recall anything specific - most likely an error on my part, would be my guess</p>",
        "id": 456157569,
        "sender_full_name": "starseeker",
        "timestamp": 1722690880
    },
    {
        "content": "<p>I might have an idea about what I was thinking, looking at the Tcl patch.  The first part of the patch, with the logic for CFG_RUNTIME and CFG_INSTALL, depends on Tcl_GetNameOfExecutable having something that will work with the relative paths.</p>",
        "id": 456720201,
        "sender_full_name": "starseeker",
        "timestamp": 1722897203
    },
    {
        "content": "<p>It's basically similar to what happens when _bu_dir_brlcad_root calls  wai_getExecutablePath - except in the Tcl case we don't have the equivalent of a fallback to wai_getModulePath</p>",
        "id": 456720418,
        "sender_full_name": "starseeker",
        "timestamp": 1722897290
    },
    {
        "content": "<p>In a \"normal\" Tcl install those paths are absolute to the install path, so it's not an issue, but that's not an option for a relocatable Tcl install.</p>",
        "id": 456720655,
        "sender_full_name": "starseeker",
        "timestamp": 1722897384
    },
    {
        "content": "<p>That may be why I went ahead and set that DYLIB_INSTALL_DIR the way I did, since there wouldn't be any expectation of things working without a suitable path from Tcl_GetNameOfExecutable</p>",
        "id": 456721000,
        "sender_full_name": "starseeker",
        "timestamp": 1722897520
    },
    {
        "content": "<p>I'll try the @rpath setting anyway and we can see what happens</p>",
        "id": 456726874,
        "sender_full_name": "starseeker",
        "timestamp": 1722900526
    },
    {
        "content": "<p>Pushed to main</p>",
        "id": 456727061,
        "sender_full_name": "starseeker",
        "timestamp": 1722900615
    }
]